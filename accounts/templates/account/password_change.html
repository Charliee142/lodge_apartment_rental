{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load i18n %}

{% block head_title %}{% trans "Change Password" %}{% endblock %}

{% block content %}
<main> 
    <div class="container py-5 mt-5">
        <section class="mb-4">
            <div class="row justify-content-center">
                <div class="col-12 col-md-8 col-lg-6">
                    <div class="card shadow-lg border-0 rounded-4 animate__animated animate__fadeInUp">
                        <div class="card-body p-5">
                            <h2 class="text-center mb-4 text-primary fw-bold">{% trans "Change Password" %}</h2>

                            <form method="POST" action="{% url 'account_change_password' %}" class="password_change">
                                {% csrf_token %}
                                
                                {% for field in form %}
                                    <div class="mb-4">
                                        <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                                        <div class="input-group">
                                            {{ field }}
                                            {% if field.name == "new_password1" or field.name == "new_password2" %}
                                                <button type="button" class="btn btn-outline-secondary toggle-password">
                                                    <i class="fa fa-eye"></i>
                                                </button>
                                            {% endif %}
                                        </div>
                                        <div class="invalid-feedback">{{ field.errors }}</div>
                                    </div>
                                {% endfor %}

                                <!-- Password Strength Meter -->
                                <div id="password-strength-container" class="d-none mt-3">
                                    <p class="mb-2"><strong>Password Strength:</strong></p>
                                    <div class="progress rounded-pill">
                                        <div id="password-strength-bar" class="progress-bar" role="progressbar" 
                                             style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <small id="password-strength-text" class="text-muted"></small>
                                </div>

                                <button class="btn btn-primary btn-lg w-100 mt-4" type="submit" name="action">
                                    <i class="fas fa-lock me-2"></i> {% trans "Change Password" %}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</main>

<!-- JavaScript for Password Strength and Toggle -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const passwordField = document.querySelector("#id_new_password1");
        const strengthBar = document.querySelector("#password-strength-bar");
        const strengthText = document.querySelector("#password-strength-text");
        const strengthContainer = document.querySelector("#password-strength-container");
        const toggleButtons = document.querySelectorAll(".toggle-password");

        // Password Strength Logic
        passwordField.addEventListener("input", function () {
            const value = passwordField.value;
            let strength = 0;

            if (value.length > 6) strength += 20;
            if (/[A-Z]/.test(value)) strength += 20;
            if (/[0-9]/.test(value)) strength += 20;
            if (/[\W]/.test(value)) strength += 20;
            if (value.length > 10) strength += 20;

            strengthBar.style.width = strength + "%";
            strengthContainer.classList.remove("d-none");

            if (strength < 40) {
                strengthBar.className = "progress-bar bg-danger";
                strengthText.textContent = "Weak";
            } else if (strength < 80) {
                strengthBar.className = "progress-bar bg-warning";
                strengthText.textContent = "Moderate";
            } else {
                strengthBar.className = "progress-bar bg-success";
                strengthText.textContent = "Strong";
            }
        });

        // Toggle Password Visibility
        toggleButtons.forEach(button => {
            button.addEventListener("click", function () {
                const input = this.previousElementSibling;
                if (input.type === "password") {
                    input.type = "text";
                    this.innerHTML = '<i class="fa fa-eye-slash"></i>';
                } else {
                    input.type = "password";
                    this.innerHTML = '<i class="fa fa-eye"></i>';
                }
            });
        });
    });
</script>

<!-- FontAwesome for Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

{% endblock %}
